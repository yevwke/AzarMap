const mapWidth=1e4,mapHeight=5625,mapExtent=[0,0,1e4,5625],tileSize=256,maxZoom=6,minZoom=0,mapResolutions=[];for(let z=minZoom;z<=6;z++)mapResolutions.push(Math.pow(2,6-z));const tileLayer=new ol.layer.Tile({source:new ol.source.XYZ({url:"tiles/{z}/{x}/{y}.webp",projection:"PIXELS",tileGrid:new ol.tilegrid.TileGrid({extent:mapExtent,resolutions:mapResolutions,tileSize:256}),wrapX:!1})}),vectorSource=new ol.source.Vector({features:window.features}),markerLayer=new ol.layer.Vector({source:vectorSource,style:function(e){let t=e===hoveredFeature?.24:.19;return new ol.style.Style({image:new ol.style.Icon({src:e.get("icon"),scale:t,anchor:[.5,.5]})})}}),view=new ol.View({projection:new ol.proj.Projection({code:"PIXELS",units:"pixels",extent:mapExtent}),center:[5e3,2812.5],zoom:2,minZoom:minZoom,maxZoom:6,extent:mapExtent,enableRotation:!1}),map=new ol.Map({target:"map",layers:[tileLayer,markerLayer],view:view});function fitMap(){let e=map.getSize();if(!e)return;view.fit(mapExtent,{size:e,constrainResolution:!0});let t=e[0]/1e4,i=e[1]/5625;view.setMinZoom(Math.min(t,i))}fitMap(),window.addEventListener("resize",fitMap);const tooltip=document.getElementById("tooltip"),sidebar=document.getElementById("sidebar"),overlayTooltip=new ol.Overlay({element:tooltip,offset:[0,-30],positioning:"bottom-center"});map.addOverlay(overlayTooltip);let hoveredFeature=null;function showSidebar(e){let t="";e.url&&""!==e.url.trim()&&(t=`<button class="popup-btn" onclick="window.open('${e.url}', '_blank')">Подробнее</button>`);let i="";e.image&&""!==e.image.trim()&&(i=`<img src="${e.image}" alt="${e.name}">`),sidebar.innerHTML=`

    ${i}
    <h2>${e.name}</h2>
    <p>${e.description}</p>
    ${t}
  `,sidebar.classList.remove("sidebar-hidden"),sidebar.style.right="0"}function hideSidebar(){sidebar.style.right=window.innerWidth<=810?"-105%":"-33%",setTimeout(()=>{sidebar.classList.add("sidebar-hidden")},400)}function springClampView(){let e=map.getSize();if(!e)return;let t=view.getResolution(),i=e[0]/2*t,o=e[1]/2*t,n=view.getCenter().slice(),a=mapExtent[0]+i,s=mapExtent[2]-i,r=mapExtent[1]+o,l=mapExtent[3]-o;n[0]<a&&(n[0]+=(a-n[0])*.01),n[0]>s&&(n[0]+=(s-n[0])*.01),n[1]<r&&(n[1]+=(r-n[1])*.01),n[1]>l&&(n[1]+=(l-n[1])*.01),view.setCenter(n)}map.on("pointermove",function(e){let t=map.forEachFeatureAtPixel(e.pixel,e=>e);if(t!==hoveredFeature&&(hoveredFeature=t,map.render(),markerLayer.changed()),t){let i=t.getProperties(),o=i.preview&&""!==i.preview.trim()?`<img src="${i.preview}">`:"";tooltip.innerHTML=`${o}<b>${i.name}</b>`,overlayTooltip.setPosition(e.coordinate),tooltip.style.display="block",map.getTargetElement().style.cursor="pointer"}else tooltip.style.display="none",map.getTargetElement().style.cursor=""}),map.on("click",e=>{let t=map.forEachFeatureAtPixel(e.pixel,e=>e);t?showSidebar(t.getProperties()):hideSidebar()});const topBtn=document.getElementById("top-btn"),topLayer=document.getElementById("top-layer");let topPlacesBtn,topMaterialsBtn,topCommunityBtn;const sidebarLeft=document.getElementById("sidebar-left"),menuBtn=document.getElementById("menu-btn");function buildLeftSidebarHTML(){let e=vectorSource.getFeatures();if(!e||0===e.length)return`<h3>Точки</h3><p style="color:#aaa;padding:10px;">Нет точек</p>`;let t=`<h3>Точки</h3>`;return e.forEach((e,i)=>{let o=e.get("name")||`Точка ${i}`;t+=`<a href="#" data-id="${i}" onclick="openPoint(${i});return false;">${o}</a>`}),t}function fillLeftSidebarTabs(){let e=document.getElementById("tab-points"),t=vectorSource.getFeatures();if(!t||0===t.length){e.innerHTML=`<p style="color:#aaa;padding:10px;">Нет точек</p>`;return}let i='<ul class="points-list">';t.forEach((e,t)=>{let o=e.get("name")||`Точка ${t}`;i+=`<li><a href="#" data-id="${t}" onclick="openPoint(${t});return false;">${o}</a></li>`}),i+="</ul>",e.innerHTML=i}fillLeftSidebarTabs(),menuBtn.addEventListener("click",()=>{sidebarLeft.classList.toggle("open"),sidebarLeft.classList.contains("open")?sidebarLeft.classList.remove("sidebar-hidden"):setTimeout(()=>{sidebarLeft.classList.add("sidebar-hidden")},400)});const initialCenter=view.getCenter().slice(),initialZoom=view.getZoom();let isSidebarZoomed=!1;function openPoint(e){let t=vectorSource.getFeatures()[e];if(t){let i=t.getGeometry().getCoordinates();showSidebar(t.getProperties()),view.animate({center:i,zoom:Math.min(view.getMaxZoom(),5),duration:1e3}),isSidebarZoomed=!0}}window.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".tab-btn"),t=document.querySelectorAll(".tab-content");e.forEach(i=>{i.addEventListener("click",()=>{let o=i.getAttribute("data-tab");e.forEach(e=>e.classList.remove("active")),i.classList.add("active"),t.forEach(e=>e.classList.remove("active")),document.getElementById(`tab-${o}`).classList.add("active")})})}),map.on("click",e=>{topPlacesBtn&&topPlacesBtn.classList.remove("active"),topMaterialsBtn&&topMaterialsBtn.classList.remove("active"),topCommunityBtn&&topCommunityBtn.classList.remove("active");let t=map.forEachFeatureAtPixel(e.pixel,e=>e);if(t){showSidebar(t.getProperties());return}sidebarLeft.classList.remove("open"),hideSidebar(),closeTopLayer(),isSidebarZoomed&&(view.animate({center:initialCenter,zoom:initialZoom,duration:800}),isSidebarZoomed=!1)});const catalogItems=[{title:"Путеводитель №1",description:"Первое знакомство с миром. Описание ключевых элементов сеттинга.",image:"covers/guide.webp",type:"link",url:"https://drive.google.com/file/d/14PV5jAM0qxoEL2gvIY-pOpGO4Stkgp16/view?usp=drive_link"},{title:"Следы на снегу",description:"Памятка о родах, духах и том, как устроена жизнь на Равнине.",image:"covers/sled.webp",type:"link",url:"https://drive.google.com/file/d/1gUKMC5ZHGOD46RxGGe7HgF2xXPB9Nkrn/view?usp=drive_link"},{title:"Охота на Земляного зверя",description:"Бессистемный модуль в духе старой школы про поиски легендарного чудовища.",image:"covers/hunt b.webp",type:"link",url:"https://drive.google.com/file/d/1rDLm4JA6IwQ5oCmjdPz4rznwPERk5GBz/view?usp=drive_link"},{title:"Круг",description:"Небольшая соло-игра, где вам предстоит взять на себя роль тагировода (оленевода).",image:"covers/crug.webp",type:"link",url:"https://drive.google.com/file/d/19yhKfyLBZEJzyG7Uf2EUp9tn452tnu8j/view?usp=drive_link"},{title:"Голод",description:"Hexcrawl модуль на правилах Пророчества о том, как дух Голода начал пожирать мир живых.",image:"covers/golod.webp",type:"link",url:"https://rpgbook.ru/prophecy_hunger?search=%D0%B3%D0%BE%D0%BB%D0%BE%D0%B4&description=true"},{title:"Стая",description:"небольшая брошюра с набором таблиц, сюжетных крючков и списком опасных и разумных противников.",image:"covers/staya.webp",type:"link",url:"https://drive.google.com/file/d/1x1dTnFJaN1ucA5qRcK8m6Btgmfi8m-em/view"},{title:"Менгир",description:"Хак на НРИ Cairn для игр в сеттинге Азар.",image:"covers/mengir.webp",type:"link",url:"https://drive.google.com/drive/folders/1rwXirDCx0XZWRtx7Kvo9ZqPItLozO-sD"},{title:"Народы равнины",description:"Адаптация Азара под правила Dungeon and Dragons пятой редакции.",image:"covers/dnd.webp",type:"link",url:"https://docs.google.com/document/d/1C9fcOKKnwvAafyTH6HKNaKI6jZWbprCDfBYFEiZRQKY/edit?tab=t.0"},{title:"Все материалы",description:"Google drive со всеми материалами.",image:"covers/drive.webp",type:"link",url:"https://drive.google.com/drive/folders/1eZSdk-_dgoiuZsRI0A1z-4QOhBsmq4z1"}],catalogContainer=document.getElementById("tab-catalog");catalogContainer.innerHTML=`
  <div class="catalog-list">
    ${catalogItems.map(e=>`
      <button class="catalog-item" onclick="openCatalogItem('${e.type}', '${e.file||e.url}')">
        <img src="${e.image}" alt="${e.title}">
        <div class="catalog-info">
          <h4>${e.title}</h4>
          <p>${e.description}</p>
        </div>
      </button>
    `).join("")}
  </div>
`;const communityItems=[{title:"Рассказы Темнейшей ночи",description:"Сборник завязок, подготовленных в рамках Азар-jam 2024.",image:"covers/night.webp",type:"link",url:"https://rpgbook.ru/tales_of_the_darkest_night"},{title:"Святилище",description:"Пять точек интереса, описывающих места поклонения духам.(автор sha_kate).",image:"covers/sanctuary.webp",type:"link",url:"https://drive.google.com/drive/folders/15fBxkrKzFNmEM5XERayoK7MNdMp3FvbC"},{title:"Бот для Круга",description:"Соло-игра Круг в телегам-боте.(автор Кирилл Шматов).",image:"covers/crug.webp",type:"link",url:"https://t.me/azar_circle_bot"},{title:"Окрылье-щит",description:"Предмет для DnD, вдохновленный защитным снаряжением народов Дальнего Востока.(автор Lui).",image:"covers/shield.webp",type:"link",url:"https://docs.google.com/document/d/179KW9c7eN6fwd7jAxqDB_t8rLeD3eJ1h/edit"},{title:"Соначорр",description:"Завязка сюжета, описывающая магический артефакт — искусственное магическое солнце.(автор ArtoLord).",image:"covers/soo.webp",type:"link",url:"https://drive.google.com/file/d/1ivIuO3JG79k-58fY3S1CRo-oB777VGK3/view?usp=drive_link"},{title:"Напитки",description:"Несколько напитков и способов их приготовления для ваших игр на Азаре.(автор Vit-Vit).",image:"covers/alko.webp",type:"link",url:"https://docs.google.com/document/d/1UAaGf5I_U-UXmJlT5-JolEsYR0FFZOis/edit"}],communityContainer=document.getElementById("tab-community");function openCatalogItem(e,t){let i=document.getElementById("sidebar");if(i&&(i.style.right=window.innerWidth<=810?"-105%":"-33%",setTimeout(()=>{i.classList.add("sidebar-hidden")},400)),"pdf"===e){let o=document.getElementById("top-layer");o.classList.remove("sidebar-hidden"),o.innerHTML=`

      <iframe src="${t}" style="width:100%; height:100%; border:none;"
      //sandbox="allow-scripts allow-same-origin"
      ></iframe>
    `,o.classList.add("open")}else"link"===e&&window.open(t,"_blank")}function closeTopLayer(){let e=document.getElementById("top-layer");e.classList.remove("open"),setTimeout(()=>{e.classList.add("sidebar-hidden")},400)}communityContainer.innerHTML=`
 <div class="catalog-list">
   ${communityItems.map(e=>`
     <button class="catalog-item" onclick="openCatalogItem('${e.type}', '${e.file||e.url}')">
       <img src="${e.image}" alt="${e.title}">
       <div class="catalog-info">
         <h4>${e.title}</h4>
         <p>${e.description}</p>
       </div>
     </button>
   `).join("")}
 </div>
`,document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("sidebar-left");topPlacesBtn=document.getElementById("btn-places"),topMaterialsBtn=document.getElementById("btn-materials"),topCommunityBtn=document.getElementById("btn-community");let t=Array.from(document.querySelectorAll(".tab-btn")),i=Array.from(document.querySelectorAll(".tab-content")),o=document.getElementById("menu-btn");if(!e){console.warn("sidebar-left element not found");return}function n(e){t.forEach(t=>{t.getAttribute("data-tab")===e?t.classList.add("active"):t.classList.remove("active")}),i.forEach(t=>{t.id===`tab-${e}`?t.classList.add("active"):t.classList.remove("active")})}function a(t){let i=e.classList.contains("open"),o=document.querySelector(".tab-btn.active"),a=document.querySelector(`.tab-btn[data-tab="${t}"]`);if(i&&o===a){e.classList.remove("open"),setTimeout(()=>e.classList.add("sidebar-hidden"),400),topPlacesBtn&&topPlacesBtn.classList.remove("active"),topMaterialsBtn&&topMaterialsBtn.classList.remove("active"),topCommunityBtn&&topCommunityBtn.classList.remove("active");return}e.classList.remove("sidebar-hidden"),e.classList.add("open"),n(t),topPlacesBtn&&topPlacesBtn.classList.toggle("active","points"===t),topMaterialsBtn&&topMaterialsBtn.classList.toggle("active","catalog"===t),topCommunityBtn&&topCommunityBtn.classList.toggle("active","community"===t)}topPlacesBtn&&topPlacesBtn.addEventListener("click",()=>a("points")),topMaterialsBtn&&topMaterialsBtn.addEventListener("click",()=>a("catalog")),topCommunityBtn&&topCommunityBtn.addEventListener("click",()=>a("community")),t.forEach(e=>{e.addEventListener("click",t=>{let i=e.getAttribute("data-tab");n(i)})}),o&&o.addEventListener("click",()=>{e.classList.toggle("open"),e.classList.contains("open")?e.classList.remove("sidebar-hidden"):setTimeout(()=>e.classList.add("sidebar-hidden"),400)})}),document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("sidebar"),t=document.getElementById("top-layer"),i=document.getElementById("close-all-btn");if(!i||!e||!t)return;function o(){let i=!e.classList.contains("sidebar-hidden")&&""!==e.style.right,o=t.classList.contains("open");return i||o}function n(){i.classList.toggle("visible",o())}function a(){e.classList.contains("sidebar-hidden")||(e.style.right=window.innerWidth<=810?"-105%":"-33%",setTimeout(()=>e.classList.add("sidebar-hidden"),400)),t.classList.contains("open")&&(t.classList.remove("open"),setTimeout(()=>t.classList.add("sidebar-hidden"),400)),n()}i.addEventListener("click",a);let s=new MutationObserver(n);s.observe(e,{attributes:!0,attributeFilter:["class","style"]});let r=new MutationObserver(n);r.observe(t,{attributes:!0,attributeFilter:["class"]}),window.addEventListener("resize",n),n()}),map.on("moveend",springClampView),map.on("change:resolution",springClampView),document.addEventListener("touchend",e=>{let t=Date.now();window.lastTouch&&t-window.lastTouch<500&&e.preventDefault(),window.lastTouch=t},!1);